<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta CRECI - Verifique Corretores e Imobili치rias</title>
    <meta name="description" content="Consulte registros de corretores e imobili치rias usando o n칰mero do CRECI. Verifique a situa칞칚o profissional de forma r치pida, gratuita e confi치vel.">

    <!-- Open Graph SEO -->
    <meta property="og:title" content="Consulta CRECI - Verifique Corretores e Imobili치rias">
    <meta property="og:description" content="Consulte registros de corretores e imobili치rias usando o n칰mero do CRECI. Gr치tis e r치pido.">
    <meta property="og:image" content="/logo.png">
    <meta property="og:type" content="website">

    <link rel="icon" type="image/png" href="logo.png" sizes="32x32">
    <link rel="preload" href="/css.css" as="style">
    <link rel="stylesheet" href="/css.css">
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
	<header id="top-bar">
		<div class="container">
		  <div class="logo">
			<h1>
                <img src="/logo-branca.png" alt="Logo Busca CRECI - Consulta de Corretores" width="40" style="vertical-align: middle;">
                Busca CRECI
            </h1>
		  </div>

		  <div class="user-controls" id="user-controls">
			<!-- Aqui o login/logout ser치 gerenciado via JS -->
		  </div>
		</div>
	</header>

    <main>
        <section id="consulta">
            <h2>Consulte o Registro de Corretores e Imobili치rias</h2>
            <p>Exemplo de n칰mero: <strong>RJ1234J</strong></p>
            <input type="text" id="creci" placeholder="Digite o n칰mero CRECI" aria-label="Digite o n칰mero CRECI" oninput="consultarCreciAuto()">
            <p id="feedback"></p>
        </section>

        <section id="legenda">
            <h3>Legenda</h3>
            <p><span id="legenda_implementado"></span> Implementado</p>
            <p><span id="legenda_nao_implementado"></span> N칚o implementado</p>
        </section>
    </main>

    <footer>
        <a href="https://github.com/19950512/buscacreci" target="_blank" title="Ver no GitHub">
            <img src="https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/github.svg" alt="GitHub Busca CRECI" width="30">
        </a>
        <a href="open-source.html">游댑 Sobre Open Source</a>
        <a href="https://nubank.com.br/cobrar/1ac1f/67b71b4b-1710-4ff8-aed6-2c8e2100e8db" target="_blank">游눘 Apoie o Projeto</a>
    </footer>

	<script>
		const userControls = document.getElementById('user-controls');
        let timerConsulta;

        function consultarCreciAuto() {
            clearTimeout(timerConsulta);
            timerConsulta = setTimeout(() => {
                const creci = document.getElementById('creci').value.trim();
                if (creci) {
                    consultarCreci();
                } else {
                    feedback.innerHTML = '';
                }
            }, 1000); // Espera 1 segundo depois da 칰ltima tecla
        }

        // Detecta se est치 no ambiente de desenvolvimento (localhost) ou produ칞칚o
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const apiUrl = isDevelopment ? 'http://localhost:8053' : 'https://api.buscacreci.com.br';  // Troque o URL de produ칞칚o aqui

        function renderUser() {
            const name = localStorage.getItem('user_name');

            if (name) {
                userControls.innerHTML = `
                    <span style="margin-right: 10px;">游녦 Ol치, ${name}</span>
                    <button onclick="logout()" style="margin-left: 5px;">Sair</button>
                `;
            } else {
                userControls.innerHTML = `
                    <!-- Google Login -->
                    <div id="g_id_onload"
                        data-client_id="207757088389-nlemog73prsh5rfeg1ckbm2cv50cvjjc.apps.googleusercontent.com"
                        data-callback="handleCredentialResponse"
                        data-auto_prompt="true"
                        data-scope="openid profile email">
                    </div>
                    <div class="g_id_signin" data-type="standard" data-size="large"></div>
                `;
            }
        }
        function handleCredentialResponse(response) {
            const jwt = response.credential;
            const payloadBase64 = jwt.split('.')[1];

            // Decodificar a base64
            const payloadBytes = Uint8Array.from(atob(payloadBase64), c => c.charCodeAt(0));
            const payloadJson = new TextDecoder('utf-8').decode(payloadBytes);
            const payload = JSON.parse(payloadJson);

            // Verifique se a propriedade 'picture' est치 no payload
            const userProfilePicture = payload.picture;

            console.log(payload); // Verifique o conte칰do do payload no console

            if (userProfilePicture) {
                localStorage.setItem('user_picture', userProfilePicture); // Armazenar a foto de perfil no localStorage
            }

            localStorage.setItem('user_name', payload.name);
            localStorage.setItem('user_email', payload.email);
            window.location.reload(); // Recarrega a p치gina para atualizar o conte칰do com a imagem
        }


		function logout() {
			localStorage.clear();
			window.location.reload();
		}

		function consultarCreci() {
            const feedback = document.getElementById('feedback');
			const creci = document.getElementById('creci').value.trim();

            feedback.innerHTML = `
            <div class="card-creci loading">
                <div class="card-topo">
                    <div class="foto-skeleton"></div>
                    <div class="dados-principais">
                        <div class="nome-skeleton"></div>
                        <div class="situacao-skeleton"></div>
                    </div>
                </div>
                <div class="card-info">
                    <div class="linha-skeleton"></div>
                    <div class="linha-skeleton"></div>
                    <div class="linha-skeleton"></div>
                    <div class="linha-skeleton"></div>
                </div>
            </div>
            `;

			if (creci) {
				fetch(`${apiUrl}/?creci=${encodeURIComponent(creci)}`)
					.then(response => response.json())
					.then(data => {
                        let resposta = '';
                        if(data.codigo){
                            
                            resposta = `
                            <div class="card-creci">
                                <div class="card-topo">
                                    <img src="${data.fotoPerfil || '/user-default.jpg'}" alt="Foto Perfil de ${data.nomeCompleto}" class="foto-perfil">
                                    <div class="dados-principais">
                                        <h2>${data.nomeCompleto}</h2>
                                        <p class="situacao ${data.situacao.toLowerCase()}">${data.situacao}</p>
                                    </div>
                                </div>
                                <div class="card-info">
                                    <p><strong>CRECI:</strong> ${data.creciCompleto}</p>
                                    ${data.cpf ? `<p><strong>CPF:</strong> ${data.cpf}</p>` : ''}
                                    ${data.telefone ? `<p><strong>Telefone:</strong> ${data.telefone}</p>` : ''}
                                    ${data.email ? `<p><strong>Email:</strong> ${data.email}</p>` : ''}
                                    <p><strong>Cidade:</strong> ${data.cidade}</p>
                                    <p><strong>Estado:</strong> ${data.estado}</p>
                                </div>
                            </div>
                            `;
                        } else if (data.message) {
                            resposta = `<div class="card-erro">${data.message}</div>`;
                        } else {
                            resposta = `<div class="card-erro">CRECI n칚o encontrado ou inv치lido.</div>`;
                        }
                        feedback.innerHTML = resposta;

                        // Anima칞칚o na imagem de perfil
                        const imgPerfil = document.querySelector('.foto-perfil');
                        if (imgPerfil) {
                            imgPerfil.onload = () => {
                                imgPerfil.classList.add('loaded');
                            }
                        }
                        const userPicture = localStorage.getItem('user_picture');
                        if (userPicture) {
                            document.querySelector('.foto-perfil').src = userPicture; // Exibe a foto de perfil
                        }
					})
					.catch(error => {
						feedback.innerHTML = `<div class="card-erro">Erro ao consultar o CRECI.</div>`;
					});
			} else {
				feedback.innerHTML = `<div class="card-erro">Por favor, digite um n칰mero de CRECI.</div>`;
			}
		}

		// Ao carregar a p치gina
		renderUser();
	</script>
</body>
</html>
